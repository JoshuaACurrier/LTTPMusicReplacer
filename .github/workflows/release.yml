name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write   # required to create GitHub Releases

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Extract version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Publish self-contained EXE
        run: |
          dotnet publish -c Release -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:PublishTrimmed=false `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:DebugType=none `
            -p:DebugSymbols=false

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Build installer
        shell: cmd
        run: |
          mkdir installer
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss /dMyVersion=${{ steps.version.outputs.VERSION }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "ALttP MSU-1 Music Switcher ${{ steps.version.outputs.VERSION }}"
          draft: false
          prerelease: false
          body: |
            ## ALttP MSU-1 Music Switcher ${{ steps.version.outputs.VERSION }}

            ### Downloads
            | File | Description |
            |------|-------------|
            | `LTTPMusicReplacerSetup-*-win64.exe` | **Recommended** — Windows installer (no admin required) |
            | `LTTPMusicReplacer.exe` | Standalone EXE — run from anywhere, no install needed |

            ### Requirements
            - Windows 10 version 1809 or later (64-bit)
            - No .NET runtime required — fully self-contained
          files: |
            installer/LTTPMusicReplacerSetup-*-win64.exe
            bin/Release/net8.0-windows/win-x64/publish/LTTPMusicReplacer.exe
